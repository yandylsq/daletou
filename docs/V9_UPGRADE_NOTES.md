# 大乐透预测模型 V9 版本升级说明

## 📋 版本信息

- **版本号**: V9.0
- **升级日期**: 2026-01-21
- **升级原因**: 针对 26009 期预测失败进行分析与优化

## 🐛 问题分析

### 26009 期预测失败原因

**实际开奖号码**: 05 12 13 14 33 - 05 08

**号码特征分析**:
- **前区**: 05 12 13 14 33
  - 和值: 77（偏小但在合理范围内）
  - 跨度: 28
  - **关键特征: 包含三连号 12-13-14**
  - 奇偶比: 3奇2偶
  - 012路: m0=1, m1=1, m2=3
  
- **后区**: 05 08
  - 和值: 13
  - 跨度: 3

**预测失败核心原因**:

1. **三连号过度惩罚**: 旧算法对 `consecutive_pairs >= 2` 的组合扣除 350 分，导致包含三连号的组合得分过低被淘汰
2. **AC 值约束过严**: 三连号会降低差值多样性，AC值可能触发过滤阈值（< 4）
3. **和值范围偏窄**: 和值 77 虽然偏小，但在历史上有出现过，不应被完全过滤
4. **模型未充分学习罕见模式**: 历史上三连号出现频率较低，机器学习模型将其视为异常模式

## ✨ V9 版本优化内容

### 1. 连号策略优化

**旧策略** (V8及之前):
```python
if consecutive_pairs >= 2:
    score -= 350  # 过度惩罚
```

**新策略** (V9):
```python
if consecutive_pairs >= 3:
    score -= 800  # 四连号及以上：历史极少见
elif consecutive_pairs == 2:
    score -= 80   # 三连号：轻微惩罚（从-350降为-80）
elif consecutive_pairs == 1:
    score += 30   # 两连号：常见模式，加分
```

**改进效果**: 三连号不再被严重惩罚，得分从 -250 提升到 +20（相对改善 270 分）

### 2. AC 值容忍度放宽

**旧策略**:
```python
if ac_val < 4:
    score -= 500  # 完全过滤
```

**新策略**:
```python
if ac_val < 3:
    score -= 500  # 极低才完全过滤
elif ac_val < 5:
    score -= 100  # AC值偏低但可接受
```

**改进效果**: AC值为 3-4 的组合从完全淘汰改为轻微惩罚

### 3. 和值范围扩大

**新增**: 
```python
elif 70 <= red_sum <= 130:
    score += 60  # 扩大和值接受范围
```

**改进效果**: 和值 70-85 和 115-130 的组合也能获得部分加分

### 4. 连号特征维度增加

**新增特征**:
- `consecutive_2`: 是否为两连号（0/1）
- `consecutive_3`: 是否为三连号（0/1）
- `consecutive_4plus`: 是否为四连号及以上（0/1）

**改进效果**: 机器学习模型可以独立学习不同连号模式的规律

### 5. 特征工程增强

**特征维度**: 从 23 维增加到 26 维

新增特征列表:
- `consecutive_2` (两连号标记)
- `consecutive_3` (三连号标记)
- `consecutive_4plus` (四连号及以上标记)

## 📊 评分对比测试

使用 V9 模型对不同连号情况进行评分测试:

| 连号类型 | 号码组合 | V8得分 | V9得分 | 改善幅度 |
|---------|---------|-------|-------|---------|
| 无连号 | 05 12 18 25 33 - 05 08 | 300分 | 300分 | 持平 |
| 两连号 | 05 12 13 20 33 - 05 08 | 270分 | 270分 | 持平 |
| **三连号** | **05 12 13 14 33 - 05 08** | **20分** | **260分** | **+240分** |
| 四连号 | 05 12 13 14 15 - 05 08 | -680分 | -620分 | 过滤 |

**结论**: V9 模型对三连号的容忍度显著提升，26009期类似号码的得分从 20分 提升到 260分

## 🔧 训练与持久化

### 训练命令

```bash
cd D:\ideaworkspace\daletou
python train_v9_model.py
```

### 模型文件

训练完成后会自动生成两个模型文件:

1. `model_assets/model_state_latest.pkl` (约 26MB) - 默认模型
2. `model_assets/model_state_v9_latest.pkl` (约 26MB) - V9版本备份

### 加载模型

```python
from model_engine import DaletouPredictor

# 创建预测器
predictor = DaletouPredictor()

# 加载 V9 模型
if predictor.load_state(tag='v9_latest'):
    print("成功加载 V9 模型")
else:
    print("使用默认模型")
```

## 📈 预期改进效果

1. **覆盖率提升**: 能够捕捉到更多包含三连号的开奖模式
2. **得分合理性**: 罕见但合理的号码组合不再被过度惩罚
3. **模型泛化能力**: 通过增加连号特征维度，模型能更好地学习不同连号模式
4. **预测多样性**: 评分范围扩大，候选组合更加多元化

## ⚠️ 注意事项

1. **四连号仍然严格过滤**: 历史上极少出现，保持高惩罚值（-800分）
2. **AC值底线保留**: AC值 < 3 仍然严格过滤，确保号码离散度
3. **模型重训练**: V9版本修改了特征维度，需要重新训练所有模型
4. **向后兼容**: 加载旧版本模型时会自动降级，不影响正常使用

## 📝 版本历史

| 版本 | 日期 | 主要变更 |
|-----|------|---------|
| V9.0 | 2026-01-21 | 修复三连号过度惩罚，放宽AC值容忍度，扩大和值范围，增加连号特征维度 |
| V8.0 | 2026-01-20 | 全量枚举评分 + 实时流式输出 + 确定性保证 |
| V7.0 | 2026-01-18 | 多模型融合 + MMR多样性过滤 |
| V6.0 | 2026-01-15 | Stacking集成学习 + LSTM时序预测 |

## 🔗 相关文档

- [功能模块说明](./01_功能模块说明.md)
- [系统设计文档](./02_系统设计文档.md)
- [开发维护手册](./04_开发维护手册.md)

---

**更新时间**: 2026-01-21 22:20  
**维护人员**: Daletou Team
