# 大乐透智能预测系统

[![Version](https://img.shields.io/badge/version-v2.0-blue.svg)](https://github.com/yourusername/daletou)
[![Python](https://img.shields.io/badge/python-3.8+-green.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/license-MIT-orange.svg)](LICENSE)

## 📋 系统简介

基于**多维度统计分析**、**机器学习模型融合**和**全量枚举评分**的大乐透智能预测系统。系统集成了 Stacking 元学习、LSTM 时序预测、网页参考分析等多种先进算法，提供科学的号码组合推荐服务。

⚠️ **重要声明**：本系统仅供娱乐和学习用途，彩票开奖为随机事件，任何预测结果不构成投注建议。请理性购彩。

---

## ✨ 核心特性

### 🎯 技术亮点

- ✅ **全量枚举评分**：对所有符合条件的号码组合（200万-500万组）进行逐一评分
- ✅ **多模型融合**：集成 RandomForest、GradientBoosting、LSTM 等模型
- ✅ **实时流式输出**：Server-Sent Events 实现预测结果实时显示
- ✅ **确定性保证**：基于期号的随机种子，确保相同输入产生相同结果
- ✅ **可解释性**：每组预测提供详细选号理由（和值、重号、模型置信度等）
- ✅ **网页参考分析**：智能提取外部预测网页的推荐号码，融入评分系统
- ✅ **回测验证**：支持历史期次模拟预测，评估模型准确率和覆盖率

### 🔧 功能模块

| 模块 | 功能描述 | 状态 |
|------|---------|------|
| **开始预测** | 为未开奖的下一期生成智能预测 | ✅ 已实现 |
| **回测验证** | 对历史期次进行模拟预测 | ✅ 已实现 |
| **网页参考** | 从外部网页提取推荐号码 | ✅ 已实现 |
| **历史查询** | 查询历史开奖记录 | ✅ 已实现 |
| **任务中止** | 支持长耗时任务取消 | ✅ 已实现 |

---

## 🚀 快速开始

### 1. 环境要求

- **Python**: 3.8 或更高版本（推荐 3.10+）
- **操作系统**: Windows / macOS / Linux
- **内存**: 至少 2GB 可用内存

### 2. 安装依赖

```bash
# 克隆项目（如果从仓库）
git clone https://github.com/yourusername/daletou.git
cd daletou

# 创建虚拟环境（推荐）
python -m venv .venv

# 激活虚拟环境
# Windows:
.venv\Scripts\activate
# macOS/Linux:
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

**主要依赖**：
- Flask >= 2.0（Web 框架）
- Flask-CORS（跨域支持）
- Pandas（数据处理）
- NumPy（数值计算）
- Scikit-learn（机器学习）
- PyTorch（深度学习，用于 LSTM）
- NetworkX（图算法）
- BeautifulSoup4（网页解析）
- Requests（HTTP 请求）

### 3. 启动服务

#### 方式一：使用启动脚本（Windows）
```bash
double-click start.bat
```

#### 方式二：手动启动
```bash
# 激活虚拟环境（如果使用）
.venv\Scripts\activate

# 启动 Flask 服务器
python app.py
```

**启动成功后**，终端会显示：
```
* Running on http://127.0.0.1:5000
* Running on http://192.168.x.x:5000
```

### 4. 访问系统

打开浏览器访问：**http://localhost:5000**

---

## 📖 使用指南

### 🎲 开始预测

1. **填写预测期号**：输入目标期号（如 `26009`）
2. **设置过滤条件**（可选）：
   - **杀红球**：输入要排除的前区号码，逗号分隔（如 `1,2,35`）
   - **杀蓝球**：输入要排除的后区号码，逗号分隔（如 `1,12`）
   - **和值范围**：设置前区和值范围（如 `80-120`）
   - **奇偶比**：设置前区奇偶比（如 `3:2` 或 `2:3`）
3. **添加参考网页**（可选）：
   - 输入预测网页地址（如头条网文章）
   - 系统会自动提取推荐号码并加权评分
4. **点击"开始预测"**
5. **查看结果**：系统实时推送 Top 20 组预测结果

**预测结果示例**：
```
排名 #1
红球：03 12 19 28 34
蓝球：02 09
评分：1245.67
理由：和值理想 | 前区全新号 | 模型强力推荐(0.52) | 蓝球1小1大
```

---

### 🔬 回测验证

1. **设置回测区间**：
   - 起始期号（如 `25001`）
   - 结束期号（如 `25080`）
2. **点击"开始回测"**
3. **查看指标**：
   - **平均命中率**：前区平均命中 2.15 个，后区平均命中 0.87 个
   - **核心覆盖率**：达到 4+2 或 5+X 的期次占比 12.5%
   - **软覆盖率**：达到 3+1、3+2、4+0、4+1 的期次占比 45.8%
   - **命中分布**：R0+B0 ~ R5+B2 的详细统计

---

### 📚 历史查询

点击"历史开奖"标签，查看系统内置的历史开奖记录（包含期号、日期、红球、蓝球）。

---

## 🏗️ 技术架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (Frontend)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ 预测界面 │  │ 回测界面 │  │ 历史查询 │  │ 导出功能 │ │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬────┘ │
└───────┼─────────────┼─────────────┼─────────────┼──────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                         │ HTTP/SSE
┌────────────────────────┼─────────────────────────────────┐
│                 API 网关层 (Flask)                       │
│  ┌─────────────────────┴─────────────────────┐          │
│  │     app.py (路由控制 + SSE 流式响应)      │          │
│  └─────────────────────┬─────────────────────┘          │
└────────────────────────┼─────────────────────────────────┘
                         │
┌────────────────────────┼─────────────────────────────────┐
│                   业务逻辑层 (Business)                  │
│  ┌──────────────────┐  ┌──────────────────┐             │
│  │ DaletouPredictor │  │  ModelEngine     │             │
│  │   (预测引擎)     │  │  (模型管理)      │             │
│  └────────┬─────────┘  └────────┬─────────┘             │
│           │                     │                        │
│  ┌────────┴─────────────────────┴─────────┐             │
│  │      号码生成 + 评分 + 过滤逻辑        │             │
│  └────────────────────┬───────────────────┘             │
└───────────────────────┼──────────────────────────────────┘
                        │
┌───────────────────────┼──────────────────────────────────┐
│                 机器学习层 (ML)                          │
│  ┌────────────────┐  ┌────────────┐  ┌────────────┐     │
│  │ Stacking Model │  │ LSTM Model │  │ Graph Model│     │
│  │   (集成学习)   │  │  (时序)    │  │  (网络)    │     │
│  └────────────────┘  └────────────┘  └────────────┘     │
└───────────────────────┼──────────────────────────────────┘
                        │
┌───────────────────────┼──────────────────────────────────┐
│                   数据层 (Data)                          │
│  ┌─────────────────┐  ┌─────────────────┐               │
│  │ 历史开奖数据    │  │  模型缓存文件   │               │
│  │ .txt / .csv     │  │  .pkl / .json   │               │
│  └─────────────────┘  └─────────────────┘               │
└──────────────────────────────────────────────────────────┘
```

---

## 📊 核心算法体系

系统包含 **12个核心算法**，贯穿数据准备、模型训练、预测生成、结果输出四个阶段：

| 阶段 | 算法名称 | 功能说明 | 技术实现 |
|------|---------|---------|----------|
| **数据准备** | HistoryDataLoader | 加载历史开奖数据 | 从txt/csv读取并解析 |
|  | LotteryDataEnricher | 175维特征工程 | 统计/频率/遗漏/连续/时序特征 |
| **模型训练** | StackingEnsembleModel | Stacking集成学习 | RandomForest+XGBoost+LightGBM+LinearRegression |
|  | LSTMTimeSeriesModel | LSTM时序预测 | 双层LSTM网络捕捉趋势 |
|  | GraphNetworkModel | 图网络关联分析 | 基于NetworkX的号码关联 |
| **预测生成** | ExhaustiveScoring | 全量枚举评分 | 200万-500万组合逐一打分 |
|  | PreFilterConditions | 前置强制过滤 | 6项必备条件(历史开奖/四连号/等差等比/全奇偶/同区) |
|  | UserDefinedFilter | 用户自定义过滤 | 5项可选条件(奇偶/和值/大小/区间/尾号) |
|  | MMRDiversityFilter | 多样性过滤 | Maximum Marginal Relevance避免相似 |
| **结果输出** | RankingAndOutput | 排序与输出 | 按综合得分降序排列 |
|  | SSEStreamingResponse | 实时流式推送 | Server-Sent Events技术 |
|  | BacktestValidator | 回测验证 | 模拟历史期次进行验证 |

---

## 🎯 评分系统

每个号码组合的最终得分由 **基础得分** 和 **模型加成** 两部分组成：

```
综合得分 = 基础得分(100-500) × 模型加成系数(1.0-9.56)
```

### 基础得分维度

- **历史频率得分**（0-100分）：号码在历史中的出现频率
- **冷热号平衡**（0-100分）：冷号与热号的合理搭配
- **遗漏值评估**（0-100分）：号码的遗漏期数分析
- **连续性得分**（0-100分）：号码间的连续性特征
- **多样性得分**（0-100分）：号码分布的多样性

### 模型加成系数

- **Stacking集成模型**：权重 40%，系数范围 1.0-3.0
- **LSTM时序模型**：权重 35%，系数范围 1.0-2.8
- **图网络模型**：权重 25%，系数范围 1.0-2.4
- **最高加成**：三模型叠加最高可达 9.56 倍

**评分范围**：100 分（最低）～ 4780 分（最高）

---

## 🔍 过滤条件体系

### 前置强制过滤（6项）

系统会自动过滤掉不符合以下条件的号码组合：

1. **历史开奖过滤**：排除已开出的号码组合
2. **四连号过滤**：排除包含4个及以上连续号码的组合（如01-02-03-04）
3. **等差数列过滤**：排除纯等差数列组合（如05-10-15-20-25）
4. **等比数列过滤**：排除纯等比数列组合（如02-04-08-16-32）
5. **全奇/全偶过滤**：排除5个前区号全奇数或全偶数的组合
6. **同区号码过滤**：排除5个前区号全在同一区间（1-7, 8-14, 15-21, 22-28, 29-35）的组合

### 用户自定义过滤（5项）

用户可以在「开始预测」页面自定义以下过滤条件：

1. **奇偶比例**：前区奇数个数（0-5个）
2. **和值范围**：前区5个号码的总和（65-175）
3. **大小比例**：前区大号（≥18）的个数（0-5个）
4. **区间分布**：前区号码必须分布在指定的几个区间
5. **尾号限制**：限制某些尾号的出现次数（如尾号1不能超过2个）

### 回测模式特殊说明

在「回测验证」模式下，系统会自动排除选定期次及之后的所有开奖数据，确保模拟的真实性。

---

## 📁 项目结构

```
daletou/
├── app.py                          # Flask主应用入口
├── model_manager.py                # 机器学习模型管理器
├── number_generator.py             # 号码生成与评分引擎
├── web_reference.py                # 网页参考功能模块
├── history_query.py                # 历史查询功能模块
├── requirements.txt                # Python依赖列表
├── README.md                       # 项目说明文档（本文件）
├── static/                         # 前端静态资源
│   ├── css/                        # 样式文件
│   │   └── style.css
│   └── js/                         # JavaScript文件
│       ├── predict.js              # 开始预测页面
│       ├── backtest.js             # 回测验证页面
│       ├── reference.js            # 网页参考页面
│       └── history.js              # 历史查询页面
├── templates/                      # HTML模板
│   ├── index.html                  # 主页
│   ├── predict.html                # 开始预测
│   ├── backtest.html               # 回测验证
│   ├── reference.html              # 网页参考
│   └── history.html                # 历史查询
├── data/                           # 数据目录
│   ├── dlt_history_with_header.txt # 历史开奖数据
│   └── models/                     # 训练好的模型缓存
│       ├── stacking_model.pkl
│       ├── lstm_model.h5
│       └── graph_model.json
├── docs/                           # 完整技术文档（2600+行）
│   ├── 01_功能模块说明.md           # 各功能模块详细说明（600+行）
│   ├── 02_系统设计文档.md           # 架构设计和算法说明（700+行）
│   ├── 03_API接口文档.md            # 所有API的详细说明（500+行）
│   ├── 04_开发维护手册.md           # 开发规范和维护指南（400+行）
│   └── 05_用户使用指南.md           # 面向终端用户的操作手册（400+行）
└── logs/                           # 日志目录
    └── app.log                     # 应用运行日志
```

---

## 📚 文档中心

`docs/` 目录包含 **5个完整的技术文档**，总计 **2600+ 行**，涵盖系统的方方面面：

| 文档名称 | 内容说明 | 行数 | 适用对象 |
|---------|---------|------|----------|
| **功能模块说明** | 5大功能模块的详细说明，包括交互流程、技术实现、代码示例 | 600+ | 开发者、产品经理 |
| **系统设计文档** | 五层架构设计、12个核心算法、评分体系、过滤条件、数据流 | 700+ | 架构师、高级开发者 |
| **API接口文档** | 11个API端点的详细说明，包括请求参数、响应格式、错误码 | 500+ | 前端开发者、集成开发者 |
| **开发维护手册** | 开发环境搭建、代码规范、测试方法、部署流程、故障排查 | 400+ | 运维工程师、开发者 |
| **用户使用指南** | 面向终端用户的操作手册，包括功能介绍、使用步骤、FAQ | 400+ | 终端用户、客服人员 |

**查看方式**：文档均为 Markdown 格式，可直接在 GitHub 或任何 Markdown 阅读器中查看。

---

## ❓ 常见问题

### Q1: 预测准确率如何？

A: 彩票本质上是随机事件，系统通过机器学习算法提高号码的「合理性」而非「准确性」。回测数据显示，系统生成的号码在统计特征上更接近真实开奖数据，但**不保证中奖**。

### Q2: 为什么预测需要很长时间？

A: 系统采用**全量枚举评分算法**，需要对 200万-500万 个号码组合逐一计算得分，因此耗时较长（通常5-15分钟）。系统支持 SSE 实时进度推送和任务中止功能。

### Q3: 如何更新历史开奖数据？

A: 将最新的开奖数据追加到 `data/dlt_history_with_header.txt` 文件末尾，格式为：
```
期号,前区1,前区2,前区3,前区4,前区5,后区1,后区2
24001,03,07,15,23,32,05,09
```

### Q4: 回测验证的意义是什么？

A: 回测可以验证系统在历史期次的表现。选择一个历史期次（如24100期），系统会排除该期及之后的数据，模拟当时的预测效果，帮助用户评估系统性能。

### Q5: 网页参考功能如何使用？

A: 输入任何包含号码推荐的网页URL（如彩票论坛、专家推荐页面），系统会自动提取页面中的号码组合，并进行合法性验证和得分计算，为用户提供参考。

### Q6: 系统是否支持其他彩票？

A: 当前版本仅支持**大乐透**（前区35选5，后区12选2）。如需支持其他彩票（如双色球、福彩3D），需要修改 `number_generator.py` 中的号码范围和组合规则。

---

## 🔄 版本迭代

### v2.0.0 (2024-12) 🎉

**重大更新**：全量枚举评分算法 + 完整文档体系

**新增功能**：
- ✨ **全量枚举评分**：对 200万-500万 个号码组合逐一评分，确保最优结果
- 🤖 **多模型融合**：Stacking + LSTM + 图网络三模型协同工作
- 🔄 **实时流式输出**：基于 SSE 技术，实时推送预测进度
- 🎯 **确定性保证**：基于期号设置随机种子，相同输入产生相同结果
- 🛡️ **前置强制过滤**：6项条件自动过滤不合理组合
- 📊 **评分系统升级**：基础得分（100-500）× 模型加成（1.0-9.56）
- 📚 **完整文档体系**：5个文档，2600+ 行，涵盖开发、运维、使用全流程
- 🚫 **任务中止功能**：支持取消长耗时的预测任务
- 🔍 **回测验证增强**：自动排除选定期次后的数据，确保回测真实性
- 🌐 **网页参考优化**：智能提取网页中的号码推荐

**技术架构升级**：
- 五层架构设计（前端层 → API层 → 业务层 → ML层 → 数据层）
- 12个核心算法贯穿四个阶段（数据准备 → 模型训练 → 预测生成 → 结果输出）
- 175维特征工程（统计、频率、遗漏、连续、时序特征）
- MMR多样性过滤算法

**代码质量提升**：
- 新增 2600+ 行技术文档
- 代码注释覆盖率 80%+
- 统一异常处理和日志记录
- 前后端代码分离，易于维护

### v1.0.0 (2024-06)

**初始版本**：基础预测功能

- ✅ 开始预测：基于历史数据生成下一期预测
- ✅ 回测验证：对历史期次进行模拟预测
- ✅ 网页参考：从外部网页提取推荐号码
- ✅ 历史查询：查询历史开奖记录
- ✅ 基础过滤条件：奇偶比例、和值范围、大小比例
- ✅ 简单评分算法：基于历史频率和遗漏值

---

## 📜 免责声明

⚠️ **重要提示**：

1. 本系统仅供**技术研究和学习交流**使用，不构成任何购彩建议。
2. 彩票开奖结果具有**完全随机性**，任何预测方法均无法保证中奖。
3. 请**理性购彩，量力而行**，切勿沉迷或过度投入。
4. 使用本系统产生的任何后果由用户自行承担，开发者不承担任何法律责任。
5. 本系统遵循所在地区的法律法规，不得用于商业用途或非法活动。

**再次提醒**：理性购彩，量力而行！🎲

---

## 📄 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件

---

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

**贡献流程**：
1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 提交 Pull Request

**代码规范**：
- 遵循 PEP 8 代码风格
- 添加必要的注释和文档字符串
- 确保所有测试通过

---

## 📧 联系方式

如有问题或建议，欢迎通过以下方式联系：

- **Issue**：[GitHub Issues](https://github.com/yourusername/daletou/issues)
- **Email**：your.email@example.com

---

<div align="center">

**⭐ 如果这个项目对你有帮助，请给个 Star ⭐**

**Made with ❤️ by [Your Name]**

**最后更新**: 2024-12

</div>
